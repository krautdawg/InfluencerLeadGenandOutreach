<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K+L Influence - Lead Generation</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- K+L Influence Style Guide CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='kl-influence-style.css') }}">
    <!-- Custom Workspace Styles -->
    <style>
        /* Fullscreen modal with constrained content width */
        #emailWorkspaceModal .modal-dialog {
            margin: 0;
            max-width: 100%;
            width: 100%;
            height: 100vh;
        }
        
        #emailWorkspaceModal .modal-content {
            height: 100vh;
            border-radius: 0;
            max-width: 1400px; /* Constrain content width for readability */
            margin: 0 auto;
            width: 100%;
        }
        
        #emailWorkspaceModal .modal-body {
            overflow-y: auto;
            padding: 2rem 3rem;
        }
        
        /* Offcanvas z-index above modal for interaction */
        .offcanvas {
            z-index: 1060 !important; /* Above modal */
            background-color: #ffffff !important; /* Ensure bright white background */
        }
        
        /* Remove all backdrop dimming effects */
        .offcanvas-backdrop,
        .modal-backdrop.offcanvas-backdrop {
            display: none !important;
        }
        
        /* Ensure modal backdrop doesn't interfere */
        .modal-backdrop {
            z-index: 1049 !important;
        }
        
        /* Modal itself needs proper z-index */
        .modal {
            z-index: 1050 !important;
        }
        
        /* Offcanvas styling */
        .offcanvas-footer {
            border-top: 1px solid #dee2e6;
            background-color: #f8f9fa;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }
        
        .offcanvas-body {
            padding-bottom: 80px; /* Account for fixed footer */
        }
        
        /* Ensure offcanvas panels are properly sized */
        .offcanvas-start,
        .offcanvas-end {
            width: 400px !important;
            max-width: 90vw;
        }
        
        /* Remove any dimming or opacity effects */
        .offcanvas.show,
        .offcanvas.showing {
            opacity: 1 !important;
            background-color: #ffffff !important;
        }
        
        /* Variables section styling for better checkbox visibility */
        #offcanvasVariablesList {
            padding-left: 2rem;
            margin-top: 1rem;
        }
        
        #offcanvasVariablesList .form-check {
            margin-bottom: 0.75rem;
            padding-left: 0.5rem;
            margin-left: 0.5rem;
        }
        
        /* Custom offcanvas implementation for dual panels */
        .custom-offcanvas {
            position: fixed;
            top: 0;
            bottom: 0;
            z-index: 1045;
            width: 400px;
            background-color: #ffffff;
            border: 1px solid #dee2e6;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            overflow-y: auto;
            visibility: hidden;
        }
        
        .custom-offcanvas.custom-offcanvas-start {
            left: 0;
            transform: translateX(-100%);
        }
        
        .custom-offcanvas.custom-offcanvas-end {
            right: 0;
            transform: translateX(100%);
        }
        
        .custom-offcanvas.custom-show {
            transform: translateX(0) !important;
            visibility: visible !important;
        }
        
        /* Solution 1: No backdrop needed - removed to prevent dimming */
        
        /* Remove Bootstrap offcanvas classes and use custom ones */
        .offcanvas {
            /* Reset Bootstrap styles */
            position: static;
            transform: none;
            visibility: visible;
        }
    </style>
</head>
<body>
    <!-- Top Navigation Bar -->
    <nav class="top-nav">
        <button class="mobile-menu-toggle" id="mobileMenuToggle">
            <i class="fas fa-bars"></i>
        </button>
        <div class="nav-logo">
            <img src="{{ url_for('static', filename='kl-influence-logo.png') }}" alt="K+L Influence">
        </div>
        <div class="nav-links">
            {% if is_admin %}
            <a href="{{ url_for('admin_users') }}" class="btn btn-warning" style="margin-right: 10px;">
                <i class="fas fa-users-cog"></i>
                Benutzerverwaltung
            </a>
            {% endif %}
            <button type="button" class="btn btn-connection" id="sessionStatus">
                <img src="{{ url_for('static', filename='instagram-icon.svg') }}" alt="Instagram" class="instagram-icon">
                <span id="sessionStatusText">
                    {% if ig_sessionid %}
                        Verbunden ({{ ig_sessionid[:8] }}...)
                    {% else %}
                        Nicht verbunden
                    {% endif %}
                </span>
            </button>
            <a href="/logout" class="btn btn-secondary" style="margin-left: 10px;">
                <i class="fas fa-sign-out-alt"></i>
                Logout
                {% if current_user %}
                    ({{ current_user.username }})
                {% elif is_legacy_user %}
                    (K+L)
                {% endif %}
            </a>
        </div>
    </nav>

    <!-- Main Layout -->
    <div class="app-layout" id="appLayout">
        <!-- Sidebar Toggle Button (outside sidebar to avoid transform issues) -->
        <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar" aria-expanded="true">
            <i class="fas fa-chevron-left" id="toggleIcon"></i>
        </button>
        
        <!-- Sidebar Navigation -->
        <nav class="sidebar-nav" id="sidebarNav">
            <!-- Lead Generation Section -->
            <div class="sidebar-section">
                <h3>Lead Generation</h3>
                <div class="form-group">
                    <label for="keywordInput">Stammhashtag</label>
                    <input type="text" class="form-control" id="keywordInput" placeholder="z.B. vitalpilze">
                </div>
                <div class="form-group">
                    <label for="searchLimitInput">Anzahl hashtag Varianten</label>
                    <input type="number" class="form-control" id="searchLimitInput" value="5" min="1" max="50">
                    <small class="form-text">Max 10 (wegen Anti-Spam Filter)</small>
                </div>

                <button type="button" class="btn btn-primary w-100 btn-icon" id="runButton">
                    <i class="fas fa-play"></i>
                    <span>Leads generieren</span>
                </button>
            </div>

            <!-- Processing Status -->
            <div id="processingStatus" class="sidebar-section" style="display: none;">
                <div class="card" style="background-color: var(--color-pale-green);">
                    <div class="d-flex align-items-center gap-3">
                        <div class="spinner"></div>
                        <div>
                            <div id="statusText" style="font-weight: 600;">Processing...</div>
                            <div id="progressText" style="font-size: var(--text-body-sm); color: var(--color-medium-gray);"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Emergency Restart Section -->
            <div class="sidebar-section" style="margin-top: auto; padding-top: var(--space-lg); border-top: 1px solid var(--color-light-gray);">
                <div class="emergency-restart-container">
                    <button type="button" class="btn btn-emergency w-100 btn-icon" id="emergencyRestartBtn">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Server Neu starten</span>
                    </button>
                    <small class="form-text text-center" style="color: var(--color-medium-gray); margin-top: 8px;">
                        Nur bei Problemen verwenden
                    </small>
                </div>
            </div>

        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Results Container for dynamic content -->
            <div id="resultsContainer">
                <!-- Results Section -->
                <div id="resultsSection" style="display: none;">
                    <!-- Action Bar -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="mb-0">Lead Ergebnisse</h2>
                        <div class="d-flex gap-2 align-items-center">
                            <div class="form-check me-3">
                                <input class="form-check-input" type="checkbox" id="filterPersonalOnly" checked>
                                <label class="form-check-label" for="filterPersonalOnly" style="font-size: 14px; color: var(--color-medium-gray);">
                                    Nur Personal
                                </label>
                            </div>
                            <div id="bulkActions" style="display: none;" class="me-3">
                                <span id="selectedCount" class="text-muted me-2">0 ausgew√§hlt</span>
                                <button type="button" class="btn btn-danger btn-sm" onclick="deleteSelectedLeads()">
                                    <i class="fas fa-trash"></i> Ausgew√§hlte l√∂schen
                                </button>
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="clearFilters()">
                                <i class="fas fa-filter"></i> Filter l√∂schen
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="window.open('/export/csv', '_blank')">
                                <i class="fas fa-file-csv"></i> CSV Export
                            </button>
                            {% if is_admin %}
                            <button type="button" class="btn btn-tertiary btn-sm" onclick="clearData()">
                                <i class="fas fa-trash"></i> Alle l√∂schen
                            </button>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Table Container -->
                    <div class="table-container">
                        <!-- Pagination Controls Top -->
                        <div class="pagination-controls-top" id="paginationControlsTop" style="display: none;">
                            <div class="pagination-info">
                                <span id="resultsInfo">Zeige 0-0 von 0 Ergebnissen</span>
                            </div>
                            <div class="pagination-navigation">
                                <button class="btn btn-sm" id="firstPageBtn">Erste</button>
                                <button class="btn btn-sm" id="prevPageBtn">Zur√ºck</button>
                                <span id="pageInfo">Seite 1 von 1</span>
                                <div class="page-numbers" id="pageNumbers">
                                    <!-- Page numbers will be inserted here -->
                                </div>
                                <button class="btn btn-sm" id="nextPageBtn">Weiter</button>
                                <button class="btn btn-sm" id="lastPageBtn">Letzte</button>
                            </div>
                            <div class="pagination-size">
                                <label for="pageSizeSelect">Zeige:</label>
                                <select id="pageSizeSelect">
                                    <option value="10">10</option>
                                    <option value="25" selected>25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                    <option value="200">200</option>
                                    <option value="all">Alle</option>
                                </select>
                            </div>
                        </div>
                    <div class="table-wrapper" id="tableWrapper">
                        <table class="data-table" id="resultsTable">
                            <thead>
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" id="selectAll" class="form-check-input" title="Alle ausw√§hlen/abw√§hlen">
                                    </th>
                                    <th onclick="sortTable(0)" class="sortable">
                                        #<span class="sort-indicator">‚Üï</span>
                                        <div class="resize-handle" data-column="1"></div>
                                    </th>
                                    <th onclick="sortTable(1)" class="sortable">
                                        Name/Benutzername<span class="sort-indicator">‚Üï</span>
                                        <div class="resize-handle" data-column="2"></div>
                                    </th>
                                    <th onclick="sortTable(2)" class="sortable">
                                        hashtag<span class="sort-indicator">‚Üï</span>
                                        <div class="resize-handle" data-column="3"></div>
                                    </th>
                                    <th onclick="sortTable(3)" class="sortable">
                                        Follower<span class="sort-indicator">‚Üï</span>
                                        <div class="resize-handle" data-column="4"></div>
                                    </th>
                                    <th onclick="sortTable(4)" class="sortable">
                                        Email<span class="sort-indicator">‚Üï</span>
                                        <div class="resize-handle" data-column="5"></div>
                                    </th>
                                    <th onclick="sortTable(5)" class="sortable">
                                        Website<span class="sort-indicator">‚Üï</span>
                                        <div class="resize-handle" data-column="6"></div>
                                    </th>
                                    <th onclick="sortTable(6)" class="sortable">
                                        Post Datum<span class="sort-indicator">‚Üï</span>
                                        <div class="resize-handle" data-column="7"></div>
                                    </th>
                                    <th onclick="sortTable(7)" class="sortable">
                                        Email Status<span class="sort-indicator">‚Üï</span>
                                        <div class="resize-handle" data-column="8"></div>
                                    </th>
                                    <th style="width: 120px;">Aktionen<div class="resize-handle" data-column="9"></div></th>
                                </tr>
                                <tr class="filter-row">
                                    <th></th>
                                    <th></th>
                                    <th><input type="text" class="filter-input" id="filterNameUsername" data-column="1" placeholder="Name oder @benutzername..."></th>
                                    <th><input type="text" class="filter-input" id="filterHashtag" data-column="2" placeholder="Filtern..."></th>
                                    <th>
                                        <select class="form-control filter-select" id="filterFollowersRange">
                                            <option value="">Alle Follower</option>
                                            <option value="1-100">1 - 100</option>
                                            <option value="100-1000">100 - 1K</option>
                                            <option value="1000-10000">1K - 10K</option>
                                            <option value="10000-50000">10K - 50K</option>
                                            <option value="50000-100000">50K - 100K</option>
                                            <option value="100000-500000">100K - 500K</option>
                                            <option value="500000-1000000">500K - 1M</option>
                                            <option value="1000000-999999999">1M+</option>
                                            <option value="custom">Benutzerdefiniert...</option>
                                        </select>
                                        <input type="text" class="filter-input" id="filterFollowers" data-column="3" placeholder="> < = 1000" style="display: none; margin-top: 5px;">
                                    </th>
                                    <th><input type="text" class="filter-input" id="filterEmail" data-column="4" placeholder="Filtern..."></th>
                                    <th><input type="text" class="filter-input" id="filterWebsite" data-column="5" placeholder="Filtern..."></th>
                                    <th>
                                        <select class="form-control filter-select" id="filterPostDate">
                                            <option value="">Alle Daten</option>
                                            <option value="letzte-woche">Letzte Woche</option>
                                            <option value="letzten-monat">Letzten Monat</option>
                                            <option value="dieses-jahr">Dieses Jahr</option>
                                            <option value="alter-als">√Ñlter als...</option>
                                            <option value="benutzerdefiniert">Benutzerdefiniert</option>
                                        </select>
                                        <input type="date" class="filter-input" id="filterPostDateCustom" style="display: none; margin-top: 5px;" placeholder="√Ñlter als Datum">
                                        <div id="customDateRange" style="display: none; margin-top: 5px;">
                                            <input type="date" class="filter-input" id="filterPostDateStart" placeholder="Von" style="margin-bottom: 3px;">
                                            <input type="date" class="filter-input" id="filterPostDateEnd" placeholder="Bis">
                                        </div>
                                    </th>
                                    <th>
                                        <select class="form-control filter-select" id="filterEmailStatus">
                                            <option value="">Alle Email-Status</option>
                                            <option value="nicht-gestartet">Nicht gestartet</option>
                                            <option value="entwurf">Entwurf bereit</option>
                                            <option value="gesendet">Gesendet</option>
                                        </select>
                                    </th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="resultsBody">
                                <!-- Results will be populated here -->
                            </tbody>
                        </table>
                    </div>
                        <!-- Pagination Controls Bottom -->
                        <div class="pagination-controls-bottom" id="paginationControlsBottom" style="display: none;">
                            <div class="pagination-info">
                                <span id="resultsInfoBottom">Zeige 0-0 von 0 Ergebnissen</span>
                            </div>
                            <div class="pagination-navigation">
                                <button class="btn btn-sm" id="firstPageBtnBottom">Erste</button>
                                <button class="btn btn-sm" id="prevPageBtnBottom">Zur√ºck</button>
                                <span id="pageInfoBottom">Seite 1 von 1</span>
                                <div class="page-numbers" id="pageNumbersBottom">
                                    <!-- Page numbers will be inserted here -->
                                </div>
                                <button class="btn btn-sm" id="nextPageBtnBottom">Weiter</button>
                                <button class="btn btn-sm" id="lastPageBtnBottom">Letzte</button>
                            </div>
                            <div class="pagination-size">
                                <label for="pageSizeSelectBottom">Zeige:</label>
                                <select id="pageSizeSelectBottom">
                                    <option value="10">10</option>
                                    <option value="25" selected>25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                    <option value="200">200</option>
                                    <option value="all">Alle</option>
                                </select>
                            </div>
                        </div>
                </div>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="text-center" style="padding: var(--space-3xl) 0;">
                    <i class="fas fa-inbox" style="font-size: 48px; color: var(--color-light-gray); margin-bottom: var(--space-lg);"></i>
                    <h3 style="color: var(--color-medium-gray);">Noch keine Leads generiert</h3>
                    <p style="color: var(--color-medium-gray);">Gib ein hashtag ein und klicke auf "Leads generieren", um zu beginnen</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Session ID Modal -->
    <div class="modal" id="sessionModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h4 class="modal-title">Instagram Session Konfiguration</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="sessionInput">Instagram Session ID</label>
                    <input type="text" class="form-control" id="sessionInput" placeholder="Gib deine sessionid ein...">
                    <small class="form-text">
                        Zu finden in deinem Browser: Entwicklertools ‚Üí Application ‚Üí Cookies ‚Üí instagram.com ‚Üí sessionid
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('sessionModal')">Abbrechen</button>
                <button type="button" class="btn btn-primary" id="saveSession">Session speichern</button>
            </div>
        </div>
    </div>

    <!-- Edit Modal for Email Subject/Body -->
    <div class="modal" id="editModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h4 class="modal-title" id="editModalTitle">Inhalt bearbeiten</h4>
                <button type="button" class="close" onclick="closeModal('editModal')" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label id="editModalLabel">Inhalt</label>
                    <textarea class="form-control" id="editModalContent" rows="10"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('editModal')">Abbrechen</button>
                <button type="button" class="btn btn-primary" onclick="saveEditModal()">√Ñnderungen speichern</button>
            </div>
        </div>
    </div>

    <!-- Prompt Settings Offcanvas (Custom Implementation) - Slides from LEFT -->
    <div class="custom-offcanvas custom-offcanvas-start" id="promptOffcanvas" aria-labelledby="promptOffcanvasLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="promptOffcanvasLabel">‚ú® Prompt Einstellungen</h5>
            <button type="button" class="btn-close" onclick="hideCustomOffcanvas('promptOffcanvas')" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <!-- Error Message Container -->
            <div id="promptErrorMessage" class="alert alert-danger" style="display: none;" role="alert"></div>
            
            <!-- Prompt Type Selection -->
            <div class="mb-3">
                <label class="form-label">Prompt Typ ausw√§hlen</label>
                <div class="d-flex gap-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="offcanvasPromptMode" id="offcanvasPromptModeWithoutProduct" value="without_product" checked>
                        <label class="form-check-label" for="offcanvasPromptModeWithoutProduct">
                            Ohne Produkt
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="offcanvasPromptMode" id="offcanvasPromptModeWithProduct" value="with_product">
                        <label class="form-check-label" for="offcanvasPromptModeWithProduct">
                            Mit Produkt
                        </label>
                    </div>
                </div>
                <div class="form-text">W√§hle, ob die E-Mails ein spezifisches Produkt erw√§hnen sollen.</div>
            </div>

            <!-- Email Type Selection -->
            <div class="mb-3">
                <label for="offcanvasPromptTypeSelect" class="form-label">E-Mail Typ</label>
                <select class="form-select" id="offcanvasPromptTypeSelect">
                    <option value="subject">Betreff</option>
                    <option value="body">E-Mail Text</option>
                </select>
            </div>

            <!-- System Message -->
            <div class="mb-3">
                <label for="offcanvasSystemMessage" class="form-label">System-Nachricht</label>
                <textarea class="form-control" id="offcanvasSystemMessage" rows="6" placeholder="Gib die System-Anweisungen ein..."></textarea>
                <div class="form-text">Diese Nachricht definiert, wie die KI den Text generieren soll.</div>
            </div>

            <!-- User Message Template -->
            <div class="mb-3">
                <label for="offcanvasUserTemplate" class="form-label">Benutzer-Nachricht Vorlage</label>
                <textarea class="form-control" id="offcanvasUserTemplate" rows="3" placeholder="Gib die Vorlage f√ºr die Benutzer-Nachricht ein..."></textarea>
                <div class="form-text">Diese Vorlage wird mit den Lead-Daten gef√ºllt.</div>
            </div>

            <!-- Available Variables -->
            <div class="mb-4">
                <label class="form-label">Verf√ºgbare Variablen:</label>
                <div id="offcanvasVariablesList" class="variable-checkboxes">
                    <!-- Variables will be populated dynamically based on product selection -->
                </div>
            </div>
        </div>
        <div class="offcanvas-footer p-3 border-top">
            <button type="button" class="btn btn-primary w-100" id="savePromptOffcanvas">
                <span class="button-text">Prompt speichern</span>
            </button>
        </div>
    </div>

    <!-- Product Details Offcanvas (Custom Implementation) - Slides from RIGHT -->
    <div class="custom-offcanvas custom-offcanvas-end" id="productOffcanvas" aria-labelledby="productOffcanvasLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="productOffcanvasLabel">üì¶ Produkt bearbeiten</h5>
            <button type="button" class="btn-close" onclick="hideCustomOffcanvas('productOffcanvas')" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <!-- Error Message Container -->
            <div id="productErrorMessage" class="alert alert-danger" style="display: none;" role="alert"></div>
            
            <input type="hidden" id="offcanvasProductEditId">
            <!-- Product Selector -->
            <div class="mb-3">
                <label for="offcanvasProductSelector" class="form-label">Produkt ausw√§hlen</label>
                <select class="form-select" id="offcanvasProductSelector">
                    <option value="">-- Neues Produkt erstellen --</option>
                    <!-- Products will be populated dynamically -->
                </select>
                <div class="form-text">W√§hle ein bestehendes Produkt zum Bearbeiten oder erstelle ein neues.</div>
            </div>
            <hr>
            <div class="mb-3">
                <label for="offcanvasProductName" class="form-label">Produkt Name</label>
                <input type="text" class="form-control" id="offcanvasProductName" placeholder="Produkt Name eingeben...">
            </div>
            <div class="mb-3">
                <label for="offcanvasProductUrl" class="form-label">Produkt URL</label>
                <input type="text" class="form-control" id="offcanvasProductUrl" placeholder="https://www.beispiel.de/produkt">
            </div>
            <div class="mb-3">
                <label for="offcanvasProductImageUrl" class="form-label">Bild URL</label>
                <input type="text" class="form-control" id="offcanvasProductImageUrl" placeholder="https://www.beispiel.de/bild.jpg">
            </div>
            <div class="mb-3">
                <label for="offcanvasProductDescription" class="form-label">Beschreibung</label>
                <textarea class="form-control" id="offcanvasProductDescription" rows="3" placeholder="Produkt Beschreibung..."></textarea>
            </div>
            <div class="mb-4">
                <label for="offcanvasProductPrice" class="form-label">Preis/Gr√∂√üe</label>
                <input type="text" class="form-control" id="offcanvasProductPrice" placeholder="z.B. 50 ml">
            </div>
        </div>
        <div class="offcanvas-footer p-3 border-top">
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-danger flex-fill" id="deleteProductOffcanvas" style="display: none;">
                    <i class="fas fa-trash"></i> L√∂schen
                </button>
                <button type="button" class="btn btn-primary flex-fill" id="saveProductOffcanvas">
                    <span class="button-text">Produkt speichern</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Email Workspace Modal (Bootstrap 5) -->
    <div class="modal fade" id="emailWorkspaceModal" tabindex="-1" aria-labelledby="emailWorkspaceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="emailWorkspaceModalLabel">Email Workspace - <span id="workspaceLeadName">Loading...</span></h5>
                    <div class="d-flex gap-2 me-3">
                        <button class="btn btn-secondary btn-sm" type="button" onclick="toggleCustomOffcanvas('promptOffcanvas')" id="promptOffcanvasBtn">
                            ‚ú® Prompt Einstellungen
                        </button>
                        <button class="btn btn-secondary btn-sm" type="button" onclick="toggleCustomOffcanvas('productOffcanvas')" id="productOffcanvasBtn">
                            üì¶ Produkt bearbeiten
                        </button>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="workspaceLeadId">
                    <input type="hidden" id="workspaceUsername">
                    
                    <!-- Lead Context Display -->
                    <div class="alert alert-info mb-4">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-user me-3"></i>
                            <div>
                                <strong id="workspaceLeadFullName">Loading...</strong>
                                <small class="d-block text-muted" id="workspaceLeadInfo">@username ‚Ä¢ followers</small>
                                <small class="d-block text-muted" id="workspaceLeadHashtag">#hashtag</small>
                            </div>
                        </div>
                    </div>

                    <!-- Product Selection -->
                    <div class="form-group mb-3">
                        <label for="workspaceProductSelect" class="form-label">Produkt ausw√§hlen</label>
                        <select class="form-select" id="workspaceProductSelect">
                            <option value="">Kein Produkt</option>
                            <!-- Products will be populated dynamically -->
                        </select>
                        <div class="form-text">W√§hle ein Produkt aus oder verwende "Kein Produkt" f√ºr allgemeine Kooperationsanfragen.</div>
                    </div>

                    <!-- AI Generation -->
                    <div class="form-group mb-4">
                        <button type="button" class="btn btn-primary" id="workspaceGenerateEmailBtn" title="Subject und Inhalt mit AI generieren">
                            <i class="fas fa-magic"></i> Generate with AI
                        </button>
                    </div>

                    <!-- Email Subject -->
                    <div class="form-group mb-3">
                        <label for="workspaceEmailSubject" class="form-label">Email Betreff *</label>
                        <input type="text" class="form-control" id="workspaceEmailSubject" placeholder="Gib den Email-Betreff ein..." required maxlength="100">
                        <div class="form-text">
                            <span id="workspaceSubjectCharCount">0</span>/100 Zeichen
                        </div>
                    </div>

                    <!-- Email Content -->
                    <div class="form-group mb-3">
                        <label for="workspaceEmailContent" class="form-label">Email Inhalt *</label>
                        <textarea class="form-control" id="workspaceEmailContent" rows="8" placeholder="Gib den Email-Inhalt ein..." required></textarea>
                        <div class="form-text">
                            <span id="workspaceContentCharCount">0</span> Zeichen
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="button" class="btn btn-secondary" id="workspaceSaveDraftBtn">
                        <i class="fas fa-save"></i> Entwurf speichern
                    </button>
                    <button type="button" class="btn btn-primary" id="workspaceSendEmailBtn">
                        <i class="fas fa-paper-plane"></i> Email senden
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Expose data to JavaScript -->
    <script>
        window.leadsData = {{ leads | tojson }};
        window.productsData = {{ products | tojson }};
        window.igSessionId = "{{ ig_sessionid if ig_sessionid else '' }}";
        window.defaultProductId = {{ default_product_id | tojson }};
    </script>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- JavaScript -->
    <script src="{{ url_for('static', filename='ui.js') }}"></script>
    <script src="{{ url_for('static', filename='kl-influence-app.js') }}"></script>
    <script src="{{ url_for('static', filename='workspace-modal.js') }}"></script>
</body>
</html>