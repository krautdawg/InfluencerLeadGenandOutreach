<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K+L Influence - Lead Generation</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- K+L Influence Style Guide CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='kl-influence-style.css') }}">
</head>
<body>
    <!-- Top Navigation Bar -->
    <nav class="top-nav">
        <button class="mobile-menu-toggle" id="mobileMenuToggle">
            <i class="fas fa-bars"></i>
        </button>
        <div class="nav-logo">
            <img src="{{ url_for('static', filename='kl-influence-logo.png') }}" alt="K+L Influence">
        </div>
        <div class="nav-links">
            <button type="button" class="btn btn-connection" id="sessionStatus">
                <img src="{{ url_for('static', filename='instagram-icon.svg') }}" alt="Instagram" class="instagram-icon">
                <span id="sessionStatusText">
                    {% if ig_sessionid %}
                        Verbunden ({{ ig_sessionid[:8] }}...)
                    {% else %}
                        Nicht verbunden
                    {% endif %}
                </span>
            </button>
            <a href="/logout" class="btn btn-secondary" style="margin-left: 10px;">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </a>
        </div>
    </nav>

    <!-- Main Layout -->
    <div class="app-layout">
        <!-- Sidebar Navigation -->
        <nav class="sidebar-nav" id="sidebarNav">
            <!-- Lead Generation Section -->
            <div class="sidebar-section">
                <h3>Lead Generation</h3>
                <div class="form-group">
                    <label for="keywordInput">Stammhashtag</label>
                    <input type="text" class="form-control" id="keywordInput" placeholder="z.B. vitalpilze">
                </div>
                <div class="form-group">
                    <label for="searchLimitInput">Anzahl hashtag Varianten</label>
                    <input type="number" class="form-control" id="searchLimitInput" value="5" min="1" max="50">
                    <small class="form-text">Max 10 (wegen Anti-Spam Filter)</small>
                </div>

                <button type="button" class="btn btn-primary w-100 btn-icon" id="runButton">
                    <i class="fas fa-play"></i>
                    <span>Leads generieren</span>
                </button>
                <button type="button" class="btn btn-danger w-100 btn-icon" id="stopButton" style="display: none;">
                    <i class="fas fa-stop"></i>
                    <span>Stoppen</span>
                </button>
            </div>

            <!-- Processing Status -->
            <div id="processingStatus" class="sidebar-section" style="display: none;">
                <div class="card" style="background-color: var(--color-pale-green);">
                    <div class="d-flex align-items-center gap-3">
                        <div class="spinner"></div>
                        <div>
                            <div id="statusText" style="font-weight: 600;">Processing...</div>
                            <div id="progressText" style="font-size: var(--text-body-sm); color: var(--color-medium-gray);"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Email Generation Settings -->
            <div class="sidebar-section">
                <h3>
                    <button class="btn btn-tertiary p-0 text-left w-100" type="button" id="toggleSettings">
                        <i class="fas fa-cog"></i>
                        Email Prompts
                        <i class="fas fa-chevron-down" style="float: right;"></i>
                    </button>
                </h3>
                <div id="settingsPanel" style="display: none;">
                    <div class="form-group">
                        <label for="defaultProductSelect">Standard-Produkt für neue Emails</label>
                        <select class="form-control" id="defaultProductSelect">
                            <option value="">Kein Produkt ausgewählt</option>
                            <!-- Products will be populated dynamically -->
                        </select>
                        <small class="form-text">Dieses Produkt wird standardmäßig für neue Email-Generierungen verwendet</small>
                    </div>
                    <div class="form-group">
                        <label for="subjectPrompt">Betreff Prompt</label>
                        <textarea class="form-control" id="subjectPrompt" rows="3">{{ email_templates.subject or 'Schreibe in DU-Form eine persönliche Betreffzeile mit freundlichen Hook für eine Influencer Kooperation mit Kasimir + Liselotte. Nutze persönliche Infos (z.B. Username, BIO, Interessen), sprich sie direkt in DU-Form. .Antworte im JSON-Format: {"subject": "betreff text"}' }}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="bodyPrompt">Email Prompt</label>
                        <textarea class="form-control" id="bodyPrompt" rows="5">{{ email_templates.body or 'Erstelle eine personalisierte, professionelle deutsche E-Mail, ohne die Betreffzeile, für potenzielle Instagram Influencer Kooperationen. Die E-Mail kommt von Kasimir vom Store KasimirLieselotte. Verwende einen höflichen, professionellen Ton auf Deutsch aber in DU-Form um es casual im Instagram feel zu bleiben. Füge am Ende die Signatur mit der Website https://www.kasimirlieselotte.de/ hinzu. Antworte im JSON-Format: {"body": "email inhalt"}' }}</textarea>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Results Container for dynamic content -->
            <div id="resultsContainer">
                <!-- Results Section -->
                <div id="resultsSection" style="display: none;">
                    <!-- Action Bar -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="mb-0">Lead Ergebnisse</h2>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-secondary btn-sm" onclick="clearFilters()">
                                <i class="fas fa-filter"></i> Filter löschen
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="window.open('/export/csv', '_blank')">
                                <i class="fas fa-file-csv"></i> CSV Export
                            </button>
                            <button type="button" class="btn btn-tertiary btn-sm" onclick="clearData()">
                                <i class="fas fa-trash"></i> Alle löschen
                            </button>
                        </div>
                    </div>

                    <!-- Predefined Follower Filters -->
                    <div class="predefined-filters" id="followerPresets">
                        <label>Schnellfilter Follower:</label>
                        <button type="button" class="filter-preset" onclick="applyFollowerPreset('')">
                            Alle
                        </button>
                        <button type="button" class="filter-preset" onclick="applyFollowerPreset('1000-10000')">
                            Nano (1k-10k)
                        </button>
                        <button type="button" class="filter-preset" onclick="applyFollowerPreset('10000-50000')">
                            Mikro (10k-50k)
                        </button>
                        <button type="button" class="filter-preset" onclick="applyFollowerPreset('50000-100000')">
                            Mittel (50k-100k)
                        </button>
                        <button type="button" class="filter-preset" onclick="applyFollowerPreset('100000')">
                            Makro (100k+)
                        </button>
                    </div>

                    <!-- Table Container -->
                    <div class="table-container">
                    <div class="table-wrapper">
                        <table class="data-table" id="resultsTable">
                            <thead>
                                <tr>
                                    <th onclick="sortTable(0)" class="sortable">
                                        #<span class="sort-indicator">↕</span>
                                    </th>
                                    <th onclick="sortTable(1)" class="sortable">
                                        Benutzername<span class="sort-indicator">↕</span>
                                    </th>
                                    <th onclick="sortTable(2)" class="sortable">
                                        hashtag<span class="sort-indicator">↕</span>
                                    </th>
                                    <th onclick="sortTable(3)" class="sortable">
                                        Vollständiger Name<span class="sort-indicator">↕</span>
                                    </th>
                                    <th onclick="sortTable(4)" class="sortable">
                                        Follower<span class="sort-indicator">↕</span>
                                    </th>
                                    <th onclick="sortTable(5)" class="sortable">
                                        Email<span class="sort-indicator">↕</span>
                                    </th>
                                    <th onclick="sortTable(6)" class="sortable">
                                        Website<span class="sort-indicator">↕</span>
                                    </th>
                                    <th onclick="sortTable(7)" class="sortable">
                                        Produkt<span class="sort-indicator">↕</span>
                                    </th>
                                    <th onclick="sortTable(8)" class="sortable">
                                        Betreff<span class="sort-indicator">↕</span>
                                    </th>
                                    <th onclick="sortTable(9)" class="sortable">
                                        Email-Inhalt<span class="sort-indicator">↕</span>
                                    </th>
                                    <th onclick="sortTable(10)" class="sortable">
                                        Status<span class="sort-indicator">↕</span>
                                    </th>
                                    <th>Aktionen</th>
                                </tr>
                                <tr class="filter-row">
                                    <th></th>
                                    <th><input type="text" class="filter-input" id="filterUsername" placeholder="Filtern..."></th>
                                    <th><input type="text" class="filter-input" id="filterHashtag" placeholder="Filtern..."></th>
                                    <th><input type="text" class="filter-input" id="filterFullName" placeholder="Filtern..."></th>
                                    <th><input type="text" class="filter-input" id="filterFollowers" placeholder="> < = 1000"></th>
                                    <th><input type="text" class="filter-input" id="filterEmail" placeholder="Filtern..."></th>
                                    <th><input type="text" class="filter-input" id="filterWebsite" placeholder="Filtern..."></th>
                                    <th><input type="text" class="filter-input" id="filterProduct" placeholder="Filtern..."></th>
                                    <th><input type="text" class="filter-input" id="filterSubject" placeholder="Filtern..."></th>
                                    <th><input type="text" class="filter-input" id="filterEmailBody" placeholder="Filtern..."></th>
                                    <th><input type="text" class="filter-input" id="filterStatus" placeholder="Filtern..."></th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="resultsBody">
                                <!-- Results will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="text-center" style="padding: var(--space-3xl) 0;">
                    <i class="fas fa-inbox" style="font-size: 48px; color: var(--color-light-gray); margin-bottom: var(--space-lg);"></i>
                    <h3 style="color: var(--color-medium-gray);">Noch keine Leads generiert</h3>
                    <p style="color: var(--color-medium-gray);">Gib ein hashtag ein und klicke auf "Leads generieren", um zu beginnen</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Session ID Modal -->
    <div class="modal" id="sessionModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h4 class="modal-title">Instagram Session Konfiguration</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="sessionInput">Instagram Session ID</label>
                    <input type="text" class="form-control" id="sessionInput" placeholder="Gib deine sessionid ein...">
                    <small class="form-text">
                        Zu finden in deinem Browser: Entwicklertools → Application → Cookies → instagram.com → sessionid
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('sessionModal')">Abbrechen</button>
                <button type="button" class="btn btn-primary" id="saveSession">Session speichern</button>
            </div>
        </div>
    </div>

    <!-- Edit Modal for Email Subject/Body -->
    <div class="modal" id="editModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h4 class="modal-title" id="editModalTitle">Inhalt bearbeiten</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label id="editModalLabel">Inhalt</label>
                    <textarea class="form-control" id="editModalContent" rows="10"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Abbrechen</button>
                <button type="button" class="btn btn-primary" onclick="saveEditModal()">Änderungen speichern</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Expose data to JavaScript -->
    <script>
        window.leadsData = {{ leads | tojson }};
        window.productsData = {{ products | tojson }};
        window.igSessionId = "{{ ig_sessionid if ig_sessionid else '' }}";
        window.defaultProductId = {{ default_product_id | tojson }};
    </script>

    <!-- JavaScript -->
    <script src="{{ url_for('static', filename='kl-influence-app.js') }}"></script>
</body>
</html>